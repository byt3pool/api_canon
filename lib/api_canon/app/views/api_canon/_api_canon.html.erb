<div class='row-fluid"'>
  <div class='span12'>
    <h1><%= controller_name.titleize %></h1>
    <%- @docs.each do |action_name,doco| -%>
      <div class='row-fluid"'>
        <div class='span12'>
          <% doco_prefix = "#{doco.controller_name}_#{doco.action_name}" %>
          <% form_for :doco, :url => api_canon_test_path, :html => {:id => "#{controller_name}_#{action_name}_form"}, :prefix => (Rails.version.starts_with?("2") ? "" : doco_prefix) do |f| %>
            <%= f.hidden_field :action_name, :value => action_name %>
            <%= f.hidden_field :controller_name, :value => controller_name %>
            <%= f.hidden_field :controller_path, :value => doco.controller_path %>
            <h2><%= action_name.to_s.titleize %></h2>
            <p class='lead'><%= doco.description %></p>
            <%- if doco.params.any? -%>
              <table class='table table-striped table-bordered'>
                <thead>
                  <tr>
                    <th>Parameter</th>
                    <th>Value</th>
                    <th>Example Values</th>
                    <th>Type</th>
                    <th>Description</th>
                  </tr>
                </thead>
                <tbody>
                  <%- doco.params.each do |name, param| %>
                    <tr>
                      <td><%= name %></td>
                      <td><%= param.to_field(f, doco_prefix) %></td>
                      <td><%= param.example_values_field(f, doco_prefix) %></td>
                      <td><%= param.type %></td>
                      <td><%= param.description %></td>
                    </tr>
                  <%- end -%>
                </tbody>
              </table>
            <%- end -%>
            <%= f.submit "Test", :onclick => "generate_url_and_call_it('#{controller_name}', '#{action_name}'); return false;", :class => 'btn' %>
          <%- end -%>
          <div id='<%= "#{controller_name}_#{action_name}_results" %>' class='results'>
            <div class='urls'></div>
            <div class='curls'></div>
            <div class='response'></div>
          </div>
        </div>
      </div>
    <%- end -%>
  </div>
</div>

<script type='text/javascript'>
  function generate_url_and_call_it(controller_name, action_name) {
    var form = jQuery('#' + controller_name + '_' + action_name + '_form');
    var api_url_request = form.attr('action');
    var post_request = jQuery.post(api_url_request, form.serialize());
    post_request.done(function(data) {
      var urls_div = jQuery('#' + controller_name + '_' + action_name + '_results div.urls')
      var curls_div = jQuery('#' + controller_name + '_' + action_name + '_results div.curls')
      var response_div = jQuery('#' + controller_name + '_' + action_name + '_results div.response')
      //urls_div.html('<p>URLs generated: </p>');
      curls_div.html('<p>Curl requests generated: </p>');
      //jQuery.each(data['urls'], function(key,value) {urls_div.append(key.toUpperCase() + ': <code>' + value + '</code>')});
      jQuery.each(data['curl'], function(key,value) {curls_div.append(key.toUpperCase() + ': <code>' + value + '</code>')});
      jQuery.each(data['urls'], function(key,value) {if (key == 'get') {jQuery.get(value).done(function(data) {response_div.html('<p>Response: </p><pre>' + JSON.stringify(JSON.parse(data), undefined, 2) + '</pre>')});}});
    });
    return false;
  }
</script>

<% content_for :sidebar do %>
<ul class='nav nav-list'>
  <% ApiCanon::DocumentationStore.instance.docos.each do |key, doco| %>
    <li><%= link_to doco.first.last.controller_path, url_for(:controller => doco.first.last.controller_path, :action => :index, :format => :html) %></li>
  <% end %>
</ul>
<% end %>
